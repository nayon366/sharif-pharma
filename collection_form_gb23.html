<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GB-23 Daily Collection Entry</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* CSS Styling - (‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶ü) */
        :root {
            --primary-color: #007bff; /* ‡¶â‡¶ú‡ßç‡¶ú‡ßç‡¶¨‡¶≤ ‡¶®‡ßÄ‡¶≤ (‡¶¨‡¶æ‡¶ü‡¶®, ‡¶´‡ßã‡¶ï‡¶æ‡¶∏) */
            --primary-dark: #0056b3; /* ‡¶ó‡¶æ‡¶¢‡¶º ‡¶®‡ßÄ‡¶≤ */
            --background-color: #e9ecef; /* ‡¶ñ‡ßÅ‡¶¨ ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶ß‡ßÇ‡¶∏‡¶∞/‡¶®‡ßÄ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
            --card-background: #ffffff; /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶¶‡¶æ */
            --text-color: #343a40; /* ‡¶ó‡¶æ‡¶¢‡¶º ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü */
            --success-color: #28a745; /* ‡¶∏‡¶¨‡ßÅ‡¶ú */
            --warning-color: #ffc107; /* ‡¶π‡¶≤‡ßÅ‡¶¶ */
            --danger-color: #dc3545; /* ‡¶≤‡¶æ‡¶≤ */
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 20px; 
            background-color: var(--background-color); 
        }
        
        /* ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .container { 
            max-width: 400px; 
            margin: auto; 
            background: var(--card-background); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1), 0 0 5px rgba(0,0,0,0.05); 
        }

        h1 { 
            color: var(--primary-color);
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 1.6em;
            font-weight: 700;
        }
        label { 
            display: block; 
            margin-top: 15px; 
            margin-bottom: 5px;
            font-weight: 600; 
            color: var(--text-color); 
        }
        
        /* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        input[type="date"], input[type="text"], input[type="number"], textarea {
            width: 100%; 
            padding: 14px; 
            border: 1px solid #ced4da; /* ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶ß‡ßÇ‡¶∏‡¶∞ ‡¶¨‡¶∞‡ßç‡¶°‡¶æ‡¶∞ */
            border-radius: 8px; 
            box-sizing: border-box;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); 
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        /* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        input:focus, textarea:focus { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); /* ‡¶â‡¶ú‡ßç‡¶ú‡ßç‡¶¨‡¶≤ ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶∂‡ßç‡¶Ø‡¶æ‡¶°‡ßã */
            outline: none; 
        }

        /* ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .button-wrapper {
            display: flex; 
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background-color: var(--primary-color); 
            color: white; 
            padding: 15px; 
            border: none; 
            border-radius: 50%; 
            cursor: pointer; 
            width: 80px; 
            height: 80px;
            font-size: 0.9em; 
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); 
            transition: background-color 0.3s, transform 0.2s;
            text-transform: uppercase;
        }
        button:hover { 
            background-color: var(--primary-dark); 
            transform: scale(1.05);
        }
        
        /* ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∞‡¶Ç ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® */
        #statusMessage { margin-top: 20px; padding: 12px; border-radius: 6px; font-weight: bold; text-align: center; }
        .network-info { margin-bottom: 15px; text-align: center; }
        .offline-badge { background-color: var(--danger-color); color: white; padding: 5px 8px; border-radius: 5px; display: inline-block; margin-right: 5px; font-size: 0.9em; }
        .sync-count { background-color: var(--warning-color); color: var(--text-color); padding: 5px 8px; border-radius: 5px; display: inline-block; font-size: 0.9em; }
        .back-button {
            display: block;
            margin-bottom: 25px;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="daily_collection_entry.html" class="back-button">‚Üê Details Page ‡¶è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</a>
        
        <h1>üí∞ GB-23 Daily Collection Entry</h1> 
        
        <div id="networkStatus" class="network-info"></div>
        
        <form id="collectionForm">
            <label for="customerName">Client/Customer Name</label>
            <input type="text" id="customerName" name="Client/Customer Name" list="customer-list-gb23" 
                   placeholder="‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá..." required disabled>
            
            <datalist id="customer-list-gb23"></datalist>

            <label for="paymentReceived">Payment Received (Taka)</label>
            <input type="number" id="paymentReceived" name="Payment Received (Taka)" placeholder="e.g. 3000" required>

            <label for="invoiceValue">Invoice Value (optional)</label>
            <input type="number" id="invoiceValue" name="Invoice Value (optional)" placeholder="e.g. 5000">

            <div class="button-wrapper">
                <button type="submit" id="submitButton">SAVE</button>
            </div>
            <p id="statusMessage"></p>
        </form>
    </div>

    <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
    </script>

    <script>
        // Apps Script URL (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ GB-23 ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ URL)
        const GOOGLE_SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzt0DJEVTlPKuCddNOzSbzs1PNuF3bT_-98zyDW_a1jGaHesAUbbt16rHjCkm64d3pR/exec"; 
        
        const form = document.getElementById('collectionForm');
        const customerNameInput = document.getElementById('customerName');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const networkStatus = document.getElementById('networkStatus');
        const datalist = document.getElementById('customer-list-gb23'); // ‡¶®‡¶§‡ßÅ‡¶® Datalist ID ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞

        const OFFLINE_STORAGE_KEY = 'offlineSubmissions_GB23'; // GB-23 ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶ø
        const CUSTOMER_LIST_KEY = 'savedCustomerList_GB23'; // ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶ø (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶Ö‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º)

        // --- ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ (JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá) ---
        async function fetchCustomerList() {
            customerNameInput.placeholder = 'Loading list...';
            try {
                // GitHub ‡¶è ‡¶∞‡¶æ‡¶ñ‡¶æ customer_list.json ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ
                const response = await fetch('customer_list.json'); 
                
                if (!response.ok) {
                    throw new Error('customer_list.json failed to load.');
                }

                const fullData = await response.json();
                
                // gb-23 ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ (key: customers_gb23)
                const gb23_customers = fullData.customers_gb23 || []; 
                
                populateDatalist(gb23_customers);
                
                customerNameInput.disabled = false; // ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶®‡¶æ‡¶¨‡¶≤ ‡¶ï‡¶∞‡¶æ
                customerNameInput.placeholder = 'Type or select customer name';
                return gb23_customers;

            } catch (error) {
                console.error("Failed to fetch customer list from JSON:", error);
                customerNameInput.disabled = false;
                customerNameInput.placeholder = 'Offline list load failed. Type manually.';
                return [];
            }
        }

        // --- ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶∏‡¶∞‡¶≤‡ßÄ‡¶ï‡¶∞‡¶£ ---
        function addCustomerToSheet(newCustomerName) {
             console.log(`Checking/Adding Customer: ${newCustomerName}`);
        }

        // --- Autocomplete ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ---
        function populateDatalist(list) {
            let optionsHTML = '';
            list.forEach(customer => {
                optionsHTML += `<option value="${customer}">`;
            });
            datalist.innerHTML = optionsHTML;
        }

        // --- Network Status Checker & UI Update ---
        function updateNetworkStatus() {
            const submissions = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '[]');
            const syncCount = submissions.length;
            
            let statusHTML = '';
            if (!navigator.onLine) {
                statusHTML += '<span class="offline-badge">‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶õ‡ßá‡¶®</span>';
                submitButton.textContent = 'OFFLINE SAVE'; 
                submitButton.style.backgroundColor = 'var(--danger-color)'; // ‡¶≤‡¶æ‡¶≤
            } else {
                submitButton.textContent = 'SAVE'; 
                submitButton.style.backgroundColor = 'var(--primary-color)'; // ‡¶®‡ßÄ‡¶≤
            }
            if (syncCount > 0) {
                statusHTML += `<span class="sync-count">Pending Sync: ${syncCount}</span>`; 
            }
            networkStatus.innerHTML = statusHTML;
            
            if (navigator.onLine && syncCount > 0) {
                statusMessage.textContent = 'Internet connected! Data syncing automatically...'; 
                syncData();
            } else if (navigator.onLine && syncCount === 0) {
                statusMessage.textContent = 'All up to date ‚úÖ'; 
            } else if (!navigator.onLine && syncCount === 0) {
                statusMessage.textContent = 'Offline mode active.'; 
            }
        }


        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        document.addEventListener('DOMContentLoaded', () => {
            fetchCustomerList(); 
            updateNetworkStatus();
        });


        // --- Data Submission Logic ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            addCustomerToSheet(data['Client/Customer Name']);
            
            data.action = 'submit'; 
            data['Submission_Date'] = new Date().toLocaleDateString('en-CA'); 
            data['Submission_Time'] = new Date().toLocaleTimeString('en-US', { hour12: false }); 
            data['Group'] = 'gb-23'; // ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø gb-23 ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá

            if (navigator.onLine) {
                submitToGoogleSheet(data);
            } else {
                saveToLocalStorage(data);
            }
        });

        // --- Local Storage, Google Sheet Sync, and Synchronization Logic (unchanged) ---
        function saveToLocalStorage(data) {
            const submissions = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '[]');
            submissions.push(data);
            localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(submissions));
            
            statusMessage.style.backgroundColor = 'var(--warning-color)';
            statusMessage.style.color = 'var(--text-color)';
            statusMessage.textContent = `Saved offline! (${submissions.length} pending)`; 
            form.reset();
            updateNetworkStatus();
        }

        async function submitToGoogleSheet(data, isSync = false) {
            submitButton.disabled = true;
            statusMessage.style.backgroundColor = '#f8f9fa';
            statusMessage.style.color = 'var(--text-color)';
            statusMessage.textContent = isSync ? `Syncing (${JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '[]').length} remaining)...` : 'Submitting...';
            
            try {
                await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!isSync) {
                    statusMessage.style.backgroundColor = 'var(--success-color)';
                    statusMessage.style.color = 'white';
                    statusMessage.textContent = 'Successfully Submitted! ‚úÖ'; 
                    form.reset();
                    fetchCustomerList(); 
                }
                submitButton.disabled = false;
                return true;
            } catch (error) {
                console.error('Submission Error:', error);
                if (!isSync) {
                    saveToLocalStorage(data);
                }
                submitButton.disabled = false;
                return false;
            }
        }
        
        async function syncData() {
            const submissions = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '[]');
            if (submissions.length === 0) {
                statusMessage.textContent = 'All data synced.'; 
                updateNetworkStatus();
                return;
            }

            statusMessage.style.backgroundColor = 'var(--primary-color)';
            statusMessage.style.color = 'white';
            statusMessage.textContent = `Syncing: ${submissions.length} pending entries...`; 
            submitButton.disabled = true;

            let failedSubmissions = [];
            for (const data of submissions) {
                const success = await submitToGoogleSheet(data, true);
                if (!success) {
                    failedSubmissions.push(data); 
                }
            }
            
            if (failedSubmissions.length === 0) {
                localStorage.removeItem(OFFLINE_STORAGE_KEY);
                statusMessage.style.backgroundColor = 'var(--success-color)';
                statusMessage.style.color = 'white';
                statusMessage.textContent = 'Successfully synced all data! ‚úÖ'; 
                fetchCustomerList(); 
            } else {
                localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(failedSubmissions));
                statusMessage.style.backgroundColor = 'var(--danger-color)';
                statusMessage.style.color = 'white';
                statusMessage.textContent = `Sync failed: ${failedSubmissions.length} entries remaining. Will retry.`; 
            }
            
            submitButton.disabled = false;
            updateNetworkStatus();
        }

        if (navigator.onLine) {
            syncData();
        }
    </script>
</body>
</html>

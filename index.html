<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Collection Entry</title>
    
    
<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="db.js" defer></script>
    
    <style>
        :root {
            --primary-color: #3498DB;
            --secondary-color: #27AE60;
            --background-light: #ecf0f3;
            --surface-light: #ffffff;
            --text-dark: #333333;
            --text-muted: #7f8c8d;
            --shadow-light: 6px 6px 12px rgba(0, 0, 0, 0.1), -6px -6px 12px rgba(255, 255, 255, 0.9);
            --shadow-inset: inset 2px 2px 5px rgba(0, 0, 0, 0.1), inset -2px -2px 5px rgba(255, 255, 255, 0.7);
            --border-radius: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            color: var(--text-dark);
        }

        .form-container {
            background-color: var(--surface-light);
            max-width: 400px;
            width: 100%;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            position: relative;
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 700;
        }

        label {
            display: block;
            margin-top: 18px;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--background-light);
            box-shadow: var(--shadow-inset);
            color: var(--text-dark);
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.05), inset -1px -1px 2px rgba(255, 255, 255, 0.5);
            background-color: #e2e6eb;
        }

        button[type="submit"] {
            width: 100%;
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            margin-top: 25px;
        }

        button[type="submit"]:hover {
            background-color: #2ecc71;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.15), -4px -4px 8px rgba(255, 255, 255, 0.7);
        }

        #response, #syncStatus {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9em;
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        #response {
            color: #c0392b;
            background-color: #fcecec;
            border: 1px solid #e74c3c;
        }
        #response.success {
            color: #27ae60;
            background-color: #eaf7ed;
            border: 1px solid #2ecc71;
        }
        #response.info {
            color: #2980b9;
            background-color: #e8f3f8;
            border: 1px solid #3498db;
        }

        #syncStatus {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            display: none;
        }
        
        datalist {
            /* Datalist styles */
        }
    </style>
</head>
<body>

    <div class="form-container">
        <h2>‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>
        
        <form id="collectionForm">
            <label for="date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
            <input type="date" name="date" id="date" required>
            
            <label for="customer">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
            <input name="customer" id="customer" list="customer-list" placeholder="‡¶®‡¶æ‡¶Æ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®" required autocomplete="off">
            <datalist id="customer-list"></datalist>

            <label for="payment">‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü:</label>
            <input type="number" name="payment" id="payment" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß≥3000" min="0" step="1">

            <label for="invoice">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label>
            <input type="number" name="invoice" id="invoice" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß≥5000">
            
            <button type="submit">‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>
        
        <div id="response" class="info"></div>
        <div id="syncStatus">‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡ßá‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã-‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§</div>
        
    </div>

    <script>
        // üö® Apps Script URL ‡¶è‡¶ñ‡¶® ‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã üö®
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJhFLb6i0JhfOmxtgWeaGT_1gA2LJL-PeL_N6xgqWBWz0KSuh1seLOXQzoLD-U6ktE/exec'; 
        const CUSTOMER_FETCH_URL = SCRIPT_URL + '?data=customers'; 
        
        const form = document.getElementById('collectionForm');
        const responseDiv = document.getElementById('response');
        const syncStatusDiv = document.getElementById('syncStatus');
        const customerDatalist = document.getElementById('customer-list');

        // --- IndexedDB ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã db.js ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡ßá ---

        // 1. ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ (‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßá‡¶≠)
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                date: document.getElementById('date').value,
                customer: document.getElementById('customer').value.trim(),
                payment: document.getElementById('payment').value || 0,
                invoice: document.getElementById('invoice').value || 0
            };
            
            if (!formData.customer) {
                responseDiv.className = 'error';
                responseDiv.textContent = '‚ùå ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!';
                return;
            }

            responseDiv.className = 'info';
            responseDiv.textContent = '‚è≥ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            
            try {
                // Save to IndexedDB
                await saveOffline(formData); 
                
                responseDiv.className = 'success';
                responseDiv.textContent = '‚úÖ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!';
                syncStatusDiv.style.display = 'block';
                form.reset();
                document.getElementById('date').valueAsDate = new Date(); 
                
                checkAndSync(); 
                
            } catch (error) {
                responseDiv.className = 'error';
                responseDiv.textContent = '‚ùå ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + error.message;
            }
        });

        // 2. ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ì ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ
        async function loadAndCacheCustomers() {
            if (!navigator.onLine) {
                const cachedCustomers = JSON.parse(localStorage.getItem('customerList') || '[]');
                populateDatalist(cachedCustomers);
                return;
            }

            try {
                const response = await fetch(CUSTOMER_FETCH_URL);
                const customers = await response.json();
                
                if (Array.isArray(customers)) {
                    populateDatalist(customers);
                    localStorage.setItem('customerList', JSON.stringify(customers));
                }

            } catch (error) {
                console.error("‚ùå ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶®‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•:", error);
                const cachedCustomers = JSON.parse(localStorage.getItem('customerList') || '[]');
                populateDatalist(cachedCustomers);
            }
        }

        // Datalist Populate ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function populateDatalist(customers) {
            customerDatalist.innerHTML = '';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                customerDatalist.appendChild(option);
            });
        }
        
        // 3. ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function checkAndSync() {
            // SCRIPT_URL ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶π‡¶æ‡¶∞‡ßç‡¶°‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá, ‡¶§‡¶æ‡¶á ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶π‡¶¨‡ßá
            if (!navigator.onLine) {
                const offlineRecords = await loadAllOfflineData();
                syncStatusDiv.style.display = offlineRecords.length > 0 ? 'block' : 'none';
                return;
            }

            const offlineRecords = await loadAllOfflineData();
            if (offlineRecords.length === 0) {
                syncStatusDiv.style.display = 'none';
                return;
            }

            responseDiv.className = 'info';
            responseDiv.textContent = `üöÄ ${offlineRecords.length} ‡¶ü‡¶ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`;

            for (const record of offlineRecords) {
                try {
                    // Apps Script ‡¶è POST ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(record)
                    });

                    // ‡¶Ø‡ßá‡¶π‡ßá‡¶§‡ßÅ no-cors, ‡¶Ø‡¶¶‡¶ø ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶è‡¶∞‡¶∞ ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º ‡¶§‡¶¨‡ßá ‡¶ß‡¶∞‡ßá ‡¶®‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶Ø‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                    await deleteOfflineData(record.id);
                    console.log(`‚úÖ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶á‡¶°‡¶ø ${record.id} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ì ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);

                } catch (error) {
                    console.error(`‚ùå ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶á‡¶°‡¶ø ${record.id} ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•:`, error);
                }
            }
            
            if ((await loadAllOfflineData()).length === 0) {
                responseDiv.className = 'success';
                responseDiv.textContent = `üéâ ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡ßü‡ßá‡¶õ‡ßá!`;
                syncStatusDiv.style.display = 'none';
            } else {
               responseDiv.className = 'error';
               responseDiv.textContent = `‚ö†Ô∏è ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá‡•§`;
               syncStatusDiv.style.display = 'block';
            }
        }

        window.addEventListener('load', function() {
            document.getElementById('date').valueAsDate = new Date();
            loadAndCacheCustomers();
            checkAndSync();
        });
        
        setInterval(checkAndSync, 10000); 
        setInterval(loadAndCacheCustomers, 600000); 
    </script>
</body>
</html>
